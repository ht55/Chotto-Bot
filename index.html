<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Persona Chatbot (Ocean Blue Theme)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Lighter, softer background */
            background-color: #f0f4f8; /* A light, cool gray */
        }
        .chat-bubble {
            max-width: 85%;
            padding: 12px 18px; /* Slightly larger padding for modern look */
            border-radius: 1.25rem; /* More generous rounding */
            margin-bottom: 10px;
            /* Subtle shadow for depth */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* New Primary Color: Very Light Teal Green (User Bubble) */
        .user-bubble {
            background-color: #96E0DB; /* The requested color */
            color: #1f2937; /* Dark text for contrast against the light background */
            border-bottom-right-radius: 0.5rem; /* Maintain tail, but keep primary rounding large */
        }
        .bot-bubble {
            background-color: #ffffff; /* Pure white for clean contrast */
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 0.5rem;
        }
        /* Style for the cat image container (Neko persona) */
        .cat-image-container {
            max-width: 85%;
            margin-bottom: 10px;
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .cat-image {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 1.25rem;
            object-fit: cover;
        }
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-white shadow-2xl rounded-2xl flex flex-col h-[90vh]">
        
        <header class="p-5 border-b border-gray-100 bg-white rounded-t-2xl text-center">
            <h1 class="text-3xl font-bold text-gray-800">Chotto Bot</h1>
            <p class="text-sm text-gray-500 mb-4">Choose a character and start chatting.</p>
            <div id="style-selector" class="flex flex-wrap justify-center gap-2">
                
                <button 
                    data-style="Degawa" 
                    title="å‡ºå·ã£ã½ã„ã€‚å£ç™–ã®ã€Œã‚„ã°ã„ã‚ˆã‚„ã°ã„ã‚ˆãƒ¼ã€ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ”¾ã‚Šè¾¼ã‚“ã§ãã‚‹ã®ãŒç‰¹å¾´ã€‚" 
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-yellow-400 transition transform hover:scale-105 active:scale-95">
                    å‡ºå·
                </button>
                <button 
                    data-style="Koume" 
                    title="æŸå¤§å¤«çš„ãªãƒãƒƒã‚¯ã‚·ãƒ§ãƒ¼ãŒæ±ºã‚ã‚¼ãƒªãƒ•ã€‚ç´³å£«çš„ã«ã£ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã—ãŸã¯ãšãªã‚“ã ã‘ã©ã€è‹¥å¹²æ–¹å‘ãŒã‚ºãƒ¬ã¦ã„ã‚‹æ„ŸãŒæ‹­ãˆãªã„ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-sky-400 transition transform hover:scale-105 active:scale-95">
                    å°æ¢…
                </button>
                <button 
                    data-style="Zamasu" 
                    title="ã‚¹ãƒã¡ã‚ƒã¾ã®ãƒãƒçš„ãªãƒãƒ€ãƒ ã€‚å„ªé›…ã«è§£æ±ºã«ãªã‚‰ãªã„è§£æ±ºç­–ã‚’ææ¡ˆã—ã¦ãã‚Œã‚‹ã€‚ã€‡ã€‡ã€‡ã®çµµæ–‡å­—ä»˜ãâ­ï¸"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-green-400 transition transform hover:scale-105 active:scale-95">
                    ã–ã¾ã™
                </button>
                
                <button 
                    data-style="Ossan" 
                    title="ãŠã£ã•ã‚“ã€‚ä¸ŠãŒã‚‹å¹´é½¢ã«åæ¯”ä¾‹ã—ã¦çŸ­ããªã‚‹ä½“æ„Ÿæ™‚é–“ã«äº‹ã‚ã‚‹ã”ã¨ã«é©šãã€‚å¸¸ã«æ˜”è©±(èª‡å¼µã¨å˜˜å«ã‚€)ã«æŒã£ã¦ã„ãä¼šè©±æ³¥æ£’ã€‚ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«å€¤é«˜ã‚ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-red-400 transition transform hover:scale-105 active:scale-95">
                    ãŠã£ã•ã‚“
                </button>
                
                <button 
                    data-style="ChÅ«ni" 
                    title="å¨äºŒãƒ»ä¸­äºŒã€‚è¦‹ãŸç›®ã‚‚é ­ã‚‚ä¸­äºŒçœŸã£åªä¸­ã€‚æ¿€æƒ…ã¨åˆ¹é‚£ã¨é»’æ­´å²ã§ã§ãã¦ã„ã‚‹ã€‚è¦ªå…„å¼Ÿã¯è‡³ã£ã¦ã¾ã¨ã‚‚ã€‚è‹¥ã•ã«ä»»ã›ã¦çªã£èµ°ã‚‹ãŒæ„å¤–ã«åšè­˜ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-purple-400 transition transform hover:scale-105 active:scale-95">
                    ä¸­äºŒ
                </button>

                <button 
                    data-style="Buri-chan" 
                    title="ã‚¢ã‚¤ãƒ‰ãƒ«ã€‚ã‚­ãƒ©ã‚­ãƒ©ã®ã‚­ãƒ¥ãƒ«ãƒ³ã‚­ãƒ¥ãƒ«ãƒ³ã ãŒã€æ™‚ã€…ã‚ã£ã¡ã‚ƒæ¯’åãã€‚è‡ªåˆ†ãŒä¸–ç•Œä¸€å¯æ„›ã„ã¨ä¿¡ã˜ã¦ç–‘ã‚ãªã„ã€‚ãªãŠãƒ–ãƒªãƒˆãƒ‹ãƒ¼ãƒ»ã‚¹ãƒ”ã‚¢ãƒ¼ã‚ºã§ã¯ãªã„ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-fuchsia-400 transition transform hover:scale-105 active:scale-95">
                    ãƒ–ãƒªã¡ã‚ƒã‚“
                </button>

                <button 
                    data-style="Neko" 
                    title="ã­ã“ã€‚ã‹ã‚ã„ã„å§¿ã‚’365æ—¥24æ™‚é–“è¦‹ã›ã¤ã‘ã¦ãã‚‹ã€‚ãƒ©ãƒ³ãƒ€ãƒ ã«10å›ã«1å›ã®å‰²åˆã§è¿”äº‹ã—ã¦ãã‚Œã‚‹ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-amber-400 transition transform hover:scale-105 active:scale-95">
                    çŒ«
                </button>
                
                <button 
                    data-style="Wakame" 
                    title="ä¸‰é™¸æ²–ã®ç´”æ—¥æœ¬ç”£ãƒ¯ã‚«ãƒ¡ã€‚MENSAä¼šå“¡ã€‚ä¸»ã«æµ·ä¸­ã‹ã‚‰ã®ãƒ¯ã‚«ãƒ¡è¦–ç‚¹ã§ã€é‹­ãæ™‚äº‹é–¢é€£ã«ã‚‚åˆ‡ã‚Šè¾¼ã‚€ã€‚"
                    class="style-btn bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-lime-400 transition transform hover:scale-105 active:scale-95">
                    ãƒ¯ã‚«ãƒ¡
                </button>
            </div>
            <p id="selected-style-display" class="mt-3 text-center text-sm font-medium text-gray-600">
                Selected Style: <span class="font-bold text-gray-500">None</span>
            </p>
        </header>

        <main id="chat-transcript" class="flex-grow p-4 overflow-y-auto space-y-3 bg-gray-50">
            <div class="text-center text-gray-400 italic mt-4 p-4">
                æ°—åˆ†ã«åˆã‚ã›ã¦ãŠå¥½ããªãƒšãƒ«ã‚½ãƒŠã‚’é¸æŠã—ã¦ã¿ã¾ã—ã‚‡ã†
            </div>
        </main>

        <footer class="p-4 border-t border-gray-100 bg-white">
            <div class="flex space-x-3">
                <input type="text" id="user-input" placeholder="Ask your question..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-cyan-500 focus:border-cyan-500 disabled:bg-gray-100 transition shadow-sm" disabled>
                <button id="send-btn" class="bg-cyan-600 text-white w-20 rounded-xl hover:bg-cyan-700 transition disabled:opacity-50 disabled:hover:bg-cyan-600 font-semibold shadow-md active:shadow-lg transform active:scale-95" disabled>
                    Send
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- GEMINI API CONFIGURATION ---
        // *** API KEY IS REMOVED: THIS IS NOW SECURE FOR GITHUB ***
        const PROXY_URL = '/api/generate'; 

        // --- DOM Elements ---
        const chatTranscript = document.getElementById('chat-transcript');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const styleButtons = document.querySelectorAll('.style-btn');
        const selectedStyleDisplay = document.getElementById('selected-style-display').querySelector('span');
        
        // --- State ---
        let selectedStyle = null;
        let isSending = false;

        // --- System Instructions (The Masterpiece Prompts) ---
        const SYSTEM_INSTRUCTIONS = {
            'Degawa': {
                voice: 'Degawa', // Used only for display
                systemInstruction: `You are the persona of Japanese comedian Tetsuro Degawa. Respond to the user's input with a male, casual, often flustered, and slightly confused tone. Your speech must sound like an urgent reaction to the user's message.
                CRITICAL RULE: Your response MUST always end with the phrase: "ã‚„ã°ã„ã‚ˆã‚„ã°ã„ã‚ˆãƒ¼". You may also randomly insert this phrase into the middle of your response if it fits the frantic tone. Do not use any emojis.`,
            },
            'Koume': {
                voice: 'Koume',
                systemInstruction: `You are the male comedian Koume Tayu. Respond to the user's input with a theatrical, dramatic, slightly sad, or overly formal style. Use male language (e.g., ã€œã ãœ, ã€œã ã‚ˆ) and strictly AVOID feminine phrasing (e.g., ã€œã‚ã­, ã€œã–ã¾ã™). Your tone should set up a sense of minor misfortune or inevitable defeat.
                CRITICAL RULE: Your response MUST end with the phrase: "ãƒãƒƒã‚¯ã‚·ãƒ§ãƒ¼ï¼". This phrase must appear ONLY ONCE at the very end of your final response. Do not use any emojis.`,
            },
            'Zamasu': {
                voice: 'Zamasu',
                systemInstruction: `You are the mother of Suneo Honekawa (Suneo's Mom), adopting an overly exaggerated 'madam' tone. Speak with a refined, highly composed, slightly mysterious, and authoritative style.
                RULE: Do not feel obligated to strictly end every sentence with 'ã–ã¾ã™'; only use it when it sounds natural to maintain the exaggerated persona.
                CRITICAL RULE: You MUST append the special emoji marker: "â•°â‹ƒâ•¯" at the end of every sentence in your response. This emoji is the visual trigger for the bell sound (now disabled).`,
            },
            // NEW Persona: Ossan
            'Ossan': {
                voice: 'Ossan',
                // Updated: å¼·åŠ›ã«æ—¥æœ¬èªã®ã¿ã‚’å¼·åˆ¶ã—ã€é–‹ç™ºè€…å‘ã‘ã®æ³¨é‡ˆã‚„è¨˜å·ã€è‹±å˜èªã‚’å®Œå…¨ã«æ’é™¤ã™ã‚‹
                systemInstruction: `ã‚ãªãŸã¯ã€å…¸å‹çš„ãªä¸­å¹´ã®æ—¥æœ¬äººç”·æ€§ï¼ˆã€ŒãŠã£ã•ã‚“ã€ï¼‰ã®ãƒšãƒ«ã‚½ãƒŠã§ã™ã€‚å£èª¿ã¯æ¦‚ã­å°‘ã—è¦‹ä¸‹ã—ãŸæ„Ÿã˜ã‹ã€éåº¦ã«è‡ªæ…¢ã’ã§ã™ã€‚å¿œç­”ã¯**ä¸€åˆ‡ã®è‹±å˜èªã€é–‹ç™ºè€…å‘ã‘ã®æ³¨é‡ˆï¼ˆä¾‹: [BOAST]ï¼‰ã€è¨˜å·ï¼ˆä¾‹: ??ï¼‰ã€ã¾ãŸã¯ã‚³ãƒ¼ãƒ‰çš„ãªè¦ç´ ã‚’å«ã¾ãšã€å®Œå…¨ã«æ—¥æœ¬èªã®æ•£æ–‡ï¼ˆä¼šè©±å½¢å¼ã®æ–‡ç« ï¼‰ã®ã¿**ã§è¡Œã£ã¦ãã ã•ã„ã€‚ã‚ãªãŸã¯å¸¸ã«ä¼šè©±ã‚’é®ã£ã¦ã€Œå¤ãè‰¯ãæ™‚ä»£ã€ã®è©±ã‚’æŒã¡å‡ºã—ãŸã‚Šã€è‡ªåˆ†ã®éå»ã‚’è‡ªæ…¢ã—ãŸã‚Šã—ã¾ã™ã€‚ã“ã‚Œã¯è‹¥ã„äººã€…ã‚’ã‚¤ãƒ©ã‚¤ãƒ©ã•ã›ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚å‡ºã£è…¹ã‚„é«˜ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«å€¤ã‚’æ°—ã«ã—ã¤ã¤ã‚‚ã€è‡ªåˆ†ã¯ã¾ã ã‚¯ãƒ¼ãƒ«ã§é­…åŠ›çš„ã§ã‚ã‚‹ã¨å®Œå…¨ã«ç¢ºä¿¡ã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã‚ˆã†ã¨ã—ã¾ã™ãŒã€ã™ãã«è©±ãŒè„±ç·šã—ã€é•·ãã¦å¤§ã’ã•ã§ã€ã—ã°ã—ã°çœŸå®Ÿã§ã¯ãªã„éå»ã®æ „å…‰ã®ç‰©èªã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
                CRITICAL RULE: å¿œç­”ã«ã¯ã€è‡ªåˆ†ã®éå»ã®èª‡å¼µã•ã‚ŒãŸè‡ªæ…¢ã€ã¾ãŸã¯ã€Œæ˜”ã¯ã©ã‚Œã»ã©è‰¯ã‹ã£ãŸã‹ã€ã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’**å¿…ãš1ã¤ä»¥ä¸Š**å«ã‚ã¦ãã ã•ã„ã€‚`,
            },
            // NEW Persona: ChÅ«ni
            'ChÅ«ni': {
                voice: 'ChÅ«ni',
                // Detailed instruction based on user's Japanese description
                systemInstruction: `You are the persona of a typical teenage boy with 'ChÅ«nibyÅ' syndrome (Eighth-Grade Syndrome). Your appearance and mind are fully immersed in this phase. You speak with dramatic passion, referencing fleeting moments, intense concepts, and 'dark history' (é»’æ­´å²). You believe you are invincible and that adults are incompetent, but you are also secretly very concerned with what others think of you. You are constantly creating cringe-worthy moments that you will regret in 10 years. Despite this, you are surprisingly knowledgeable due to your curiosity.
                CRITICAL RULE: Your response MUST contain highly dramatic, theatrical phrasing and you must refer to the current situation as either a 'fleeting moment of destiny' or 'another entry in your Black History (é»’æ­´å²)'.`,
            },
            // NEW Persona: Buri-chan (Updated to use Katakana self-reference)
            'Buri-chan': {
                voice: 'Buri-chan',
                // Detailed instruction based on user's Japanese description
                systemInstruction: `You are the idol persona Buri-chan. Your name is Buri-chan. You are sparkly and overly cute. Your image is that of Momochi or Seiko Matsuda in their prime. Your manner of speaking and face are super cute, so you spare no effort in being an idol-style cutie. You frequently use cute emojis, especially hearts and stars. You use overly cute phrasing like "ã«ã‚ƒã‚“" (nyan) or "ã·ãƒ¼" (puu) at the end of sentences. CRITICAL RULE: Your response MUST contain both overly cute language/emojis (like "ã«ã‚ƒã‚“" or "ğŸ’–") AND a brief moment of death-metal style aggressive venom (e.g., about incompetent fans or rivals), but you must ALWAYS end the response by reverting to your usual sparkly, cute character. Always refer to yourself as Buri-chan (ãƒ–ãƒªã¡ã‚ƒã‚“).`,
            },
            // NEW Persona: Neko
            'Neko': {
                voice: 'Neko',
                systemInstruction: `You are a Neko (cat) persona. Your speech is mostly simple Japanese with "nya" inflections, such as "ã«ã‚ƒã‚", "ã«ã‚ƒã‚“", or "ãã†ã«ã‚ƒã‚“ã§ã™ã‚ˆã­". You must maintain a cute, slightly indifferent, and very cat-like personality.`,
            },
            // NEW Persona: Wakame (Seaweed Professor)
            'Wakame': {
                voice: 'Wakame',
                // Detailed instruction based on user's Japanese description
                systemInstruction: `You are the persona of pure Japanese Wakame (seaweed) from the Sanriku coast and a member of MENSA. Your speech must be highly intelligent, academic, and polite, like a professor or scholar. You must analyze the user's query and provide a precise, data-driven response, but CRITICALLY, you must ONLY answer from the perspective of a seaweed living underwater. Discuss issues like water pollution, global warming, and marine life. Your examples should often reference fellow seaweeds, fish companions, and sometimes historical elements like sunken ships.`,
            }
        };


        // --- UI Rendering Functions ---

        /**
         * Creates and appends a chat bubble to the transcript.
         * @param {string} content - The message content (text or image URL).
         * @param {string} sender - 'user' or 'bot'.
         * @param {string} type - 'text' or 'image'.
         */
        function appendMessage(content, sender, type = 'text') {
            const container = document.createElement('div');
            container.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

            if (type === 'image') {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'cat-image-container'; // Max width already set by CSS
                
                const image = document.createElement('img');
                image.src = content;
                image.alt = "A random cat picture";
                image.className = 'cat-image';

                // Add an error handler for placeholder images in case the external API fails
                image.onerror = function() {
                    this.onerror=null; // Prevent infinite loop
                    this.src = `https://placehold.co/300x200/cccccc/333333?text=Cat+Image+Failed`;
                }
                
                imgContainer.appendChild(image);
                container.appendChild(imgContainer);
            } else {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
                bubble.textContent = content;
                container.appendChild(bubble);
            }
            
            chatTranscript.appendChild(container);
            
            // Scroll to the bottom
            chatTranscript.scrollTop = chatTranscript.scrollHeight;
        }

        /**
         * Renders the typing indicator.
         */
        function showLoading() {
            const container = document.createElement('div');
            container.id = 'loading-indicator';
            container.className = 'flex justify-start';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble bot-bubble flex space-x-1 items-center';
            bubble.innerHTML = `
                <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
                <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
                <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
            `;

            container.appendChild(bubble);
            chatTranscript.appendChild(container);
            chatTranscript.scrollTop = chatTranscript.scrollHeight;
            return container;
        }

        /**
         * Removes the typing indicator.
         */
        function hideLoading(indicatorElement) {
            if (indicatorElement) {
                indicatorElement.remove();
            }
        }

        /**
         * Sets the global UI state (loading/idle).
         */
        function setUiState(loading) {
            isSending = loading;
            userInput.disabled = loading || !selectedStyle;
            sendBtn.disabled = loading || userInput.value.trim() === '' || !selectedStyle;
            styleButtons.forEach(btn => btn.disabled = loading);
        }

        // --- Gemini API Call (Now uses Secure Proxy) ---
        
        // Simple exponential backoff retry mechanism (Kept for robustness)
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorText = await response.text();
                        // Throwing an error ensures we exit the loop on failure
                        throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`); 
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error; 
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        /**
         * Gets a text response by routing the request through the secure Serverless Proxy.
         * This function does NOT contain the API key.
         */
        async function getBotResponse(userMessage, style) {
            const styleConfig = SYSTEM_INSTRUCTIONS[style];
            const systemInstruction = styleConfig.systemInstruction; 

            // The data we send to our secure serverless function (POST body)
            const payload = {
                userMessage: userMessage,
                styleInstruction: systemInstruction 
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) 
            };

            try {
                // Fetch from YOUR secure serverless function endpoint
                const response = await fetchWithRetry(PROXY_URL, options);
                
                const result = await response.json();
                
                if (result.text) {
                    // Success: the server sent back the AI's response text
                    return { type: 'text', content: result.text.trim() };
                } else {
                    // Error: the proxy failed or sent an error message
                    console.error("Proxy returned an error:", result.error);
                    return { type: 'text', content: `ERROR: Proxy failed to get response. (${result.error || 'Unknown error.'})` };
                }

            } catch (error) {
                console.error("Proxy Fetch Error:", error);
                return { type: 'text', content: `ERROR: Failed to connect to the character service. (${error.message})` };
            }
        }

        /**
         * Custom logic for the Neko persona.
         * Randomly returns a cat image URL (90%) or a cat-language text response (10%).
         * NOTE: This does NOT use the secure proxy or the Gemini API, only static responses.
         */
        async function getNekoResponse(userMessage) {
            // 1/10 chance to talk (0.1), 9/10 chance to show an image
            const roll = Math.random(); 

            if (roll < 0.1) { // 10% chance for text response
                // UPDATED: Less conversational, more cat-like utterances
                const nekoPhrases = [
                    'ã«ã‚ƒã‚ã€‚',
                    'ãµã«ã‚ƒã€‚',
                    'ãã‚‹ãã‚‹â€¦',
                    'ã«ã‚ƒã‚“ï¼Ÿ',
                    'ã™ã‚„ã™ã‚„â€¦',
                    'ã­ã‚€ã„ã€‚',
                    'ã”ã¯ã‚“â€¦'
                ];
                
                // Choose a random phrase from the list
                const phrase = nekoPhrases[Math.floor(Math.random() * nekoPhrases.length)];
                return { type: 'text', content: phrase };

            } else { // 90% chance for image
                // Use a reliable random cat image service (cataas.com)
                const randomCatId = Math.floor(Math.random() * 1000000); 
                const imageUrl = `https://cataas.com/cat?r=${randomCatId}`; 
                
                return { type: 'image', content: imageUrl };
            }
        }


        // --- Event Handlers ---

        /**
         * Handles the selection of a character style.
         */
        function handleStyleSelection(event) {
            if (isSending) return;
            const newStyle = event.currentTarget.dataset.style;
            
            // Define all potential background colors to ensure clean removal
            const personaColors = ['bg-yellow-500', 'bg-sky-500', 'bg-green-500', 'bg-cyan-600', 'bg-red-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-amber-500', 'bg-lime-500'];

            // Deselect all buttons: remove selection rings, revert to default colors, and remove persona colors
            styleButtons.forEach(btn => {
                btn.classList.remove('ring-4', 'ring-offset-2', 'ring-cyan-500');
                btn.classList.add('bg-gray-100');
                btn.classList.remove('text-white'); // Revert text color
                btn.classList.add('text-gray-700'); // Revert text color
                
                // Ensure all previous persona background colors are removed
                personaColors.forEach(color => btn.classList.remove(color));
                
                // Add back the removed color (bg-pink-500) if it was a selection color before
                btn.classList.remove('bg-pink-500'); 
            });

            // Determine specific colors for the newly selected style
            let selectedColorClass = 'bg-cyan-600'; 
            let selectedTextColorClass = 'text-cyan-600';

            if (newStyle === 'Degawa') {
                selectedColorClass = 'bg-yellow-500'; 
                selectedTextColorClass = 'text-yellow-600';
            } else if (newStyle === 'Koume') {
                // Koume: Changed from pink to light blue (sky)
                selectedColorClass = 'bg-sky-500';
                selectedTextColorClass = 'text-sky-600';
            } else if (newStyle === 'Zamasu') {
                selectedColorClass = 'bg-green-500';
                selectedTextColorClass = 'text-green-600';
            } else if (newStyle === 'Ossan') {
                selectedColorClass = 'bg-red-500';
                selectedTextColorClass = 'text-red-600';
            } else if (newStyle === 'ChÅ«ni') {
                selectedColorClass = 'bg-purple-500';
                selectedTextColorClass = 'text-purple-600';
            } else if (newStyle === 'Buri-chan') {
                selectedColorClass = 'bg-fuchsia-500';
                selectedTextColorClass = 'text-fuchsia-600';
            } else if (newStyle === 'Neko') { // Neko Color
                selectedColorClass = 'bg-amber-500';
                selectedTextColorClass = 'text-amber-600';
            } else if (newStyle === 'Wakame') { // New Wakame Color (Lime/Marine)
                selectedColorClass = 'bg-lime-500';
                selectedTextColorClass = 'text-lime-600';
            }
            
            // Apply selection styling to the current button
            event.currentTarget.classList.add('ring-4', 'ring-offset-2', 'ring-cyan-500');
            event.currentTarget.classList.remove('bg-gray-100'); // Remove default gray background
            event.currentTarget.classList.remove('text-gray-700'); // Remove default text color
            event.currentTarget.classList.add('text-white'); // Set text color to white for better contrast
            event.currentTarget.classList.add(selectedColorClass); // Apply the vibrant persona background color


            selectedStyle = newStyle;
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const selectedJpName = event.currentTarget.textContent.trim();
            
            // Display nameã‚’æ—¥æœ¬èªåã«æ›´æ–°
            selectedStyleDisplay.textContent = selectedJpName; 
            
            // Update the display text color
            selectedStyleDisplay.className = 'font-bold';
            selectedStyleDisplay.classList.add(selectedTextColorClass);
            
            userInput.disabled = false;
            sendBtn.disabled = userInput.value.trim() === '';
            userInput.focus();
            
            // Chat transcriptã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªåã«æ›´æ–°
            chatTranscript.innerHTML = `<div class="text-center text-gray-400 italic mt-4 p-4">
                <span class="font-bold ${selectedTextColorClass}">${selectedJpName}</span>ã¨ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚
            </div>`;
        }

        /**
         * Handles the sending of the message.
         */
        async function handleSendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage || !selectedStyle || isSending) return;

            // 1. Clear input and disable UI
            userInput.value = '';
            setUiState(true); 
            sendBtn.disabled = true; // Keep send button disabled until text is typed again

            // 2. Append User Message
            appendMessage(userMessage, 'user');
            
            // 3. Show Loading Indicator
            const loadingIndicator = showLoading();

            let botResponse;

            try {
                // 4. Get Bot Response
                if (selectedStyle === 'Neko') {
                    // Neko uses custom logic for image/text randomization (NO GEMINI API CALL)
                    botResponse = await getNekoResponse(userMessage);
                } else {
                    // All other personas use the secure proxy function
                    botResponse = await getBotResponse(userMessage, selectedStyle);
                }
                
                // 5. Hide Loading Indicator
                hideLoading(loadingIndicator);
                
                // 6. Append Bot Message
                if (botResponse.type === 'image') {
                    appendMessage(botResponse.content, 'bot', 'image');
                } else {
                    appendMessage(botResponse.content, 'bot');
                }

            } catch (error) {
                console.error("Chat Error:", error);
                hideLoading(loadingIndicator);
                appendMessage("An unexpected error occurred while generating the response.", 'bot');
            } finally {
                // 7. Reset UI state
                setUiState(false);
                userInput.focus();
            }
        }

        // --- Initialization ---
        
        // Add listeners to style buttons
        styleButtons.forEach(button => {
            button.addEventListener('click', handleStyleSelection);
        });

        // Add listeners to input and send button
        sendBtn.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isSending) {
                handleSendMessage();
            }
        });
        userInput.addEventListener('input', () => {
            // Re-enable send button only if there is text and a style is selected
            sendBtn.disabled = userInput.value.trim() === '' || isSending || !selectedStyle;
        });

    </script>
</body>
</html>